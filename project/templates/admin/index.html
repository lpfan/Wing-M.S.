{% extends 'admin/master.html' %}

{%block head %}
    <link href="{{ url_for('static', filename='css/style_admin.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/ui.dynatree.css') }}" rel="stylesheet">
{%endblock%}
{%block tail%}
  {{super()}}
	<script type="text/javascript" src="{{url_for('static', filename='js/bootstrap.min.js')}}"></script>
  <script type="text/javascript" src="{{url_for('static', filename='js/jquery-ui.custom.min.js')}}"></script>
  <script type="text/javascript" src="{{url_for('static', filename='js/jquery.cookie.js')}}"></script>
  <script type="text/javascript" src="{{url_for('static', filename='js/jquery.dynatree.min.js')}}"></script>
   <script type="text/javascript" src="{{url_for('static', filename='js/jquery.form.js')}}"></script>
	<script type="text/javascript">


  function admin_item_config_handler(e){
    e.preventDefault();
    var modal = $('#myModal');
    modal.modal('show');
    return false;
  }

		$(document).ready(function(){
      $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
      });

      var itemMenuHolder;
      var itemMenuTitle;
      var menu = $('#menu_structure');
      //
      var inputItemTitle = $('#inputItemTitle');
      var inputItemUrl = $('#inputItemUrl');
      //
      var nodeParams;
      //
      var templateText = $('#itemTemplateText');
      var itemUtilityTemplate = $('#itemUtilityTemplateText');

      menu
        .find('.dropdown-toggle')
          .dropdown();

      $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
      });

      $("#tree").dynatree({
        onActivate: function(node) {
          // get params of clicked node
          nodeParams = {
            'node_title' : node.data.title,
            'node_url' : node.data.href,
            'children' : node.data.children,
            'node_key' : node.data.key
          };
          inputItemTitle.val(nodeParams.node_title);
          inputItemUrl.val(nodeParams.node_url);
          //
          return;
        },
        initAjax: {url: "{{url_for('.content_structure')}}"},
        persist: true,
      });
        
        //$('#itemTemplateText').redactor();

      function createPublicTemplate(node_title, node_url, node_children){
        var item = '';
        if (node_children && node_children.length > 0){
          var jHolder = $('<ul />');
          var jLi = $('<li />');
          $.each(node_children, function(i, val){
            jLi.clone().append(
              $('<a />')
                .prop({
                  href:val.href
                })
                .html(val.title)
                ).appendTo(jHolder);
          });
          item = '<li>' + 
                    '<a href="' + node_url + '" title="' + node_title +'">' + node_title + '</a>' + 
                    jHolder.prop('outerHTML') + 
                '</li>';
          return item;
        } 
        item = '<li><a href="' + node_url + '" title="' + node_title +'">' + node_title + '</a></li>';
        return item
      }

      function createAdminTemplate(node_title, node_url, node_key, node_children){
        var ddMenu = $('<ul />')
          .addClass('dropdown-menu')
          .prop('role', 'menu');
        var ddTitle = $('<a />')
          .prop({
            class:'dropdown-toggle',
            href:'#'
          })
          .html(node_title)
          .append(
            $('<b />').addClass('caret')
          );

        if (node_children && node_children.length > 0){
          $.each(node_children, function(i, val){
            $('<li />').append(
              $('<a />')
                .prop({
                  href:val.key,
                  class:'js_menu_item_child'
                })
                .html(val.title)
            ).appendTo(ddMenu);
          });
        }
        ddMenu.append($('<li />').addClass('divider'));
        //
        $('<li />')
          .append(
            $('<a />')
              .prop({
                class:'edit_btn js_edit_admin_menu_item',
                href:node_key
              })
              .html('edit')
          )
          .appendTo(ddMenu);
        var tmpl = ddTitle.prop('outerHTML') + ddMenu.prop('outerHTML');
        return tmpl;
      }

      function createMenuTemplate(nodeParams){
        //
        var newMenuItem = {
          'publicItem': '',
          'adminItem' : ''
        }

        //check if node has children
        if (nodeParams.children && nodeParams.children.length > 0){
          newMenuItem.publicItem = createPublicTemplate(
            nodeParams.node_title,
            nodeParams.node_url,
            nodeParams.children
          );
          newMenuItem.adminItem = createAdminTemplate(
            nodeParams.node_title,
            nodeParams.node_url,
            nodeParams.node_key,
            nodeParams.children
          );
        }else{
          newMenuItem.publicItem = createPublicTemplate(nodeParams.node_title, nodeParams.node_url);
          newMenuItem.adminItem = createAdminTemplate(nodeParams.node_title, nodeParams.node_url, nodeParams.node_key)
        }
        //
        templateText.val(newMenuItem.publicItem);
        itemUtilityTemplate.val(newMenuItem.adminItem);
        //
        return;
      }

      function correctItemTemplate (formData, jqForm, options){
        nodeParams.node_title = inputItemTitle.val();
        createMenuTemplate(nodeParams);
        return true;
      }

      function updateConstructorMenu(responseText, statusText, xhr, $form){
        $form.resetForm();
        menu
          .find('.dropdown-toggle')
            .dropdown();
        return true;
      };

      $('#js_newItemSource').ajaxForm({
        beforeSerialize : correctItemTemplate,
        success: updateConstructorMenu
      });

      menu
        .find('.js_edit_admin_menu_item')
          .on('click', admin_item_config_handler);

		});
	</script>
{%endblock%}

{% block body %}

<ul class="nav nav-tabs" id="myTab">
  <li class="active"><a href="#menu_settings">Налаштування головного меню</a></li>
  <li><a href="#profile">Profile</a></li>
  <li><a href="#messages">Messages</a></li>
  <li><a href="#settings">Settings</a></li>
</ul>
 
<div class="tab-content">
  <div class="tab-pane active" id="menu_settings">
    <div class="navbar">
      <h4>Конструктор головного меню</h4>
      <div class="navbar-inner">
        <a class="brand" href="#">Головне меню</a>
        {%if menu %}
        <ul id="menu_structure" class="nav">
          {% for m in menu %}
          <li class="dropdown">{{m.utility_template|safe}}</li>
          {%endfor%}
        </ul>
        {%endif%}
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <div id="tree"> </div>
      </div>

      <div class="span8">
        <div id="item_options">
          <form id="js_newItemSource" action="{{url_for('.new_menu_item')}}" method="POST" class="form-inline">
            <legend>
               Параметри нового пункту меню
            </legend>
            <ul class="nav nav-tabs" id="myTab">
              <li class="active"><a href="#main">Основні параметри</a></li>
              <li><a href="#additionals">Додатково</a></li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane active" id="main">
                <div class="control-group">
                  <label class="control-label" for="inputItemTitle">Назва</label>
                  <div class="controls">
                    <input name="itemTitle" type="text" id="inputItemTitle" />
                    <input type="hidden" name="itemUrl" id="inputItemUrl" />
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="additionals">
                <div class="control-group">
                  <label class="control-label" for="itemTemplateText">Шаблон</label>
                    <div class="controls">
                      <textarea name="itemTemplate" id="itemTemplateText"></textarea>
                      <textarea name="itemUtilityTemplate" id="itemUtilityTemplateText" style="display:none;"></textarea>
                    </div>
                </div>
              </div>
            </div>
            

            <div class="control-group">
              <div class="controls">
                <button class="btn btn-danger">скасувати</button>
                <input class="btn btn-primary" type="submit" value="Додати" />
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane" id="profile">...</div>
  <div class="tab-pane" id="messages">...</div>
  <div class="tab-pane" id="settings">...</div>
</div>
     
   <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" class="modal hide fade" id="myModal" style="display: none;">
            <div class="modal-header">
              <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
              <h3 id="myModalLabel">Параметри пункта меню</h3>
            </div>
            <div class="modal-body">
              
            </div>
            <div class="modal-footer">
              <button data-dismiss="modal" class="btn">Закрити</button>
              <button class="btn btn-primary">Застосувати</button>
            </div>
          </div>

{% endblock %}